# Урок 05. "Управление процессами"
## Домашнее задание
В результате ДЗ вы разберетесь что находится в файловой системе /proc и закрепите навыки работы с bash. Зачастую, например в контейнерах, у вас нет кучу удобных утилит предоставляющих информацию о процессах, ip адресах, итд И есть только один инструмент bash и /proc

Задания на выбор:
1. написать свою реализацию ps ax используя анализ /proc
	- Результат ДЗ - рабочий скрипт который можно запустить
2. написать свою реализацию lsof
	- Результат ДЗ - рабочий скрипт который можно запустить
3. дописать обработчики сигналов в прилагаемом скрипте, оттестировать, приложить сам скрипт, инструкции по использованию
	- Результат ДЗ - рабочий скрипт который можно запустить + инструкция по использованию и лог консоли
4. реализовать 2 конкурирующих процесса по IO. пробовать запустить с разными ionice
	- Результат ДЗ - скрипт запускающий 2 процесса с разными ionice, замеряющий время выполнения и лог консоли
5. реализовать 2 конкурирующих процесса по CPU. пробовать запустить с разными nice
	- Результат ДЗ - скрипт запускающий 2 процесса с разными nice и замеряющий время выполнения и лог консоли

Критерии оценки:
- 5 баллов - принято - любой скрипт
- +1 балл - больше одного скрипта
- +2 балла все скрипты

# Результат

Результатом домашнего задания является 4 скрипта `ps_ax.sh`, `lsof.sh`, `ionice.sh`, `nice.sh`. В двух последних скриптах реализована обработка сигналов.

Работа скриптов проверялась на ОС CentOS 7 и Fedora28/30.

## ps_ax.sh
Скрипт является аналогом команды `ps -ax` реализованной при помощи bash.

Не имеет входных параметров.

Скрипт получает информацию о процессах из следующих мест ФС `/proc`:

- /proc
- /proc/pid/stat
- /proc/pid/cmdline

**Пример:**
```bash
# ./ps_ax.sh
PID    TTY    STAT  TIME   COMMAND
1      ?      S     0:5    /usr/lib/systemd/systemd --switched-root --system --deserialize 32
2      ?      S     0:0
3      ?      I     0:0    [rcu_gp]
4      ?      I     0:0    [rcu_par_gp]
6      ?      I     0:0    [kworker/0:0H-kblockd]
9      ?      I     0:0    [mm_percpu_wq]
:
```

## lsof.sh
Скрипт является упрощенным аналогом команды `lsof` реализованной при помощи bash.

Скрипт получает информацию о процессах из следующих мест ФС `/proc`:
- /proc
- /proc/pid/task/pid/cwd
- /proc/pid/task/pid/root
- /proc/pid/task/pid/exe
- /proc/pid/task/pid/stat
- /proc/pid/task/pid/loginuid
- /proc/pid/task/pid/maps
- /proc/pid/task/pid/fd/

### Параметры запуска скрипта
| Параметр | Описание |
|-------|----------|
| без параметра | вывод информации об открытых файлах всех процессов в операционной системе. *(Не самый лучший вариант для запуска в системе с большим колличеством процессов и открытых файлов. Т.к. реализация выполнена на bash, процесс получения информации займет продолжительное время.)* |
| -p PID | вывод информации об открытых файлах для процесса с идентификатором PID |
| --help | вывод информации об использовании скрипта |

**Пример:**
```bash
# ./lsof.sh -p 9756
COMMAND PID  TID TASKCMD USER FD  TYPE DEVICE SIZE/OFF NODE     NAME
bash    9756             max  cwd DIR  0,0    4096     16777312 /home/max
bash    9756             max  rtr DIR  0,0    4096     96       /
bash    9756             max  txt REG  0,0    2187664  17206427 /usr/bin/bash
bash    9756             max  mem REG  0,0    368      33855480 /usr/lib/locale/en_US.utf8/LC_IDENTIFICATION
bash    9756             max  mem REG  0,0    167      33599913 /usr/lib/locale/en_US.utf8/LC_ADDRESS
:
```

## ionice.sh
Скрипт запускает одновременно два процесса, которые выполняют запись в одинакового количества данных в файлы, и выводит информацию сколько каждый процесс потратил времени и скорость записи.

> Важное замечание. `ionice` работает только с CFQ планировщиком, поэтому перед запуском скрипта для достижения желаемого результата желательно убедиться, что на устройстве используется данный планировщик.

### Параметры запуска скрипта
Скрипт принимает в качестве входного параметра название директории в которую будет выполнена запись временных файлов.

**Пример:**

- Проверяем планировщик
```bash
# cat /sys/block/sda/queue/scheduler
noop [deadline] cfq
```
- Устанавливает планировщик CFQ и проверяем повторно
```bash
# echo cfq > /sys/block/sda/queue/scheduler
# cat /sys/block/sda/queue/scheduler 
noop deadline [cfq]
```
- Запускаем скрипт
```bash
# ./ionice.sh /mnt/test-ionice/
Proccess #1 started with "ionice -c3"
Proccess #2 started with "ionice -c2 -n0"
Result for proccess #1: 0.852418 s, 601 kB/s
Result for proccess #2: 0.444143 s, 1.2 MB/s
```

## nice.sh
Скрипт запускает одновременно два процесса, которые выполняют подсчёт md5 суммы, и выводит информацию сколько каждый процесс потратил времени.
Выбранны приоритеты 0 и 19, чтобы можно было выполнить запуск скрипта с правами обычного (не root) пользователя.

Скрипт не имеет входных параметров.

**Пример:**

```bash
# ./nice.sh 
Proccess #1 started with "nice -0"
Proccess #2 started with "nice -19"
Real time for proccess #1:      0m4.441s
Real time for proccess #2:      0m8.755s
```